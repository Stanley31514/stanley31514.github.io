<!DOCTYPE html>

<html>
<head>
	<title>
			Testing
	</title>

</head>

<body style="color: white; background: rgb(35, 35, 35);">
<!-- <canvas id="myCanvas" width="200" height="200" style="border:1px solid #000000;">
</canvas> 


Enter a string <input type="text" id="user_input">
<input type="button" value="Submit" onclick="f1()")>




<script>
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext("2d");
ctx.fillStyle = "#0000FF";
ctx.fillRect(0,0,200,100);
ctx.beginPath();
ctx.arc(95,50,40,0,2*Math.PI);
ctx.stroke();
ctx.font = "30px Comic Sans MS";
ctx.fillStyle = "red";
ctx.textAlign = "center";
ctx.fillText("Hello World", canvas.width/2, canvas.height/2); 
function f1(){
	var canvas = document.getElementById("user_input");
	alert(canvas.value);
	
}
</script> -->



<video id="player" controls autoplay webkit-playsinline playsinline style="height:300px;width:300px;border: 4px solid gray;"></video>
<canvas id="canvas" width=20 height=20 style="display: none;"></canvas>
<pre id="light" style="font-size: 40px;">test</pre>
<script>
  const player = document.getElementById('player');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');

  const constraints = {
    video: {
    width: {
      min: 300,
      ideal: 300,
      max: 300,
    },
    height: {
      min: 300,
      ideal: 300,
      max: 300
    },
    facingMode: {
      exact: 'environment'
    }
  }
  };  
  
  let onTime = 0;
  let offTime = 0;
  let high = 0;
  let low = 0;
  let prev = 0;
  let state = "low";
  let prevTime = new Date();
  let prevSaveTime = prevTime;
  let codeRates = [];
  let codeRate = 0;


  function capture(event){
 
    context.drawImage(player , 0, 0, canvas.width, canvas.height);
    let data = context.getImageData(0, 0, canvas.width, canvas.height);
    let i = 0;
    let sum = 0;
    let curTime = new Date();
    while (i < data.data.length){
      let r = data.data[i++];
      let g = data.data[i++];
      let b = data.data[i++];
      let a = data.data[i++];
      sum += (r/255+g/255+b/255)*(a/255);
    }
    if (state == "low" && sum > 1.3 * prev){
      high++;
      
      offTime = curTime - prevTime;
      state = "high";
      prevTime = curTime;
      let newRate = 60000/(onTime+offTime);
      codeRates.push(newRate);
    }
    else if (state == "high" && sum < 0.7 * prev){
      low++;
      onTime = curTime - prevTime;
      state = "low";
      prevTime = curTime;
      let newRate = 60000/(onTime+offTime);
      codeRates.push(newRate);
    }
    if ((curTime - prevSaveTime) > 1000){
      prevSaveTime = curTime;
      let sumRate = 0;
      for (let rate of codeRates){
        sumRate += rate;
      }
      let newCodeRate = sumRate / codeRates.length;
      codeRate = (newCodeRate + codeRate)/2; 
      codeRates = [];
      
      /* let sumTime = 0;
      for (let rate of codeRates){
        sumTime += 60000/rate;
      }
      codeRate = (codeRates.length / 2) / (sumTime/60000); */

      high = 0;
      low = 0;
    }
    document.getElementById("light").innerText = `STATE: ${state.toUpperCase()} \nCODE: ${(codeRate).toFixed(0)} \nON: ${onTime} MSEC \nOFF: ${offTime} MSEC \n`;
    prev = sum;
  }

  navigator.mediaDevices.getUserMedia(constraints)
  .then((stream) => {
    // Attach the video stream to the video element and autoplay.
    player.srcObject = stream;
    setInterval(capture , 1);
  });

</script>

</body>


</html>
